# bo

<div align="center">

**仓位管理计算器**

支持标准投注、Polymarket 预测市场、股票交易、套利/抽水、纳什均衡、组合凯利（独立）与相关情景组合凯利（非独立）计算。

[![Release](https://img.shields.io/github/v/release/inoader/bo)](https://github.com/inoader/bo/releases/latest)
[![Build](https://img.shields.io/github/actions/workflow/status/inoader/bo/release.yml?branch=main)](https://github.com/inoader/bo/actions)

</div>

## 功能总览

- 标准模式：`赔率 + 胜率` 的凯利仓位
- Polymarket 模式：`市场价格 + 你的概率` 的凯利仓位
- 股票模式：`当前价/止盈/止损/胜率` 的风险仓位
- 套利模式：双边套利与抽水检测
- 多标的套利模式：多边套利与抽水检测
- 组合凯利模式（`-k`）：独立事件假设下的联合仓位优化
- 相关情景组合凯利模式（`-K`）：非独立事件下按联合情景优化
- 纳什均衡模式（`-n`）：2x2 双人博弈纯策略/混合策略均衡
- 全局开关：`-h/-help` 查看用法，`-v/-version` 查看版本
- 文本与 `--json` 输出（`--json` 仅用于命令行参数模式）

## 快速开始

```bash
# 查看帮助与版本
bo -h
bo -v

# 标准模式
bo 2.0 60 10000

# 纳什均衡（2x2）
bo -n 3 0 5 1 3 5 0 1

# 非独立事件组合凯利（相关情景）
# 2个标的、2个情景：
# 情景1: 概率50%，收益[+20%, -10%]
# 情景2: 概率50%，收益[-10%, +20%]
bo -K 2 2 50 20 -10 50 -10 20 10000
```

## 安装

### 方式一：下载预编译二进制

从 [Releases](https://github.com/inoader/bo/releases) 页面下载对应平台二进制。

### 方式二：源码编译

```bash
git clone https://github.com/inoader/bo.git
cd bo
cargo build --release
```

产物位于 `target/release/bo`。

## 参数规则

- `bo -h` / `bo -help` / `bo --help`：显示用法
- `bo -v` / `bo -version` / `bo --version`：显示版本
- 赔率必须大于 `1.0`
- 胜率/概率必须在 `0-100`（百分数）
- Polymarket 价格必须在 `(0, 100)`
- 本金、当前价、止盈价、止损价必须为正数
- `-k` 标的数量必须在 `2-12`
- `-K` 标的数量必须在 `1-12`，情景数量必须在 `2-128`
- `-K` 概率和应约等于 `100%`（允许四舍五入误差）
- `-K` 收益率按百分数输入，且不得小于 `-100%`
- `-n` 需要 8 个收益值（允许负数）

## 输入单位与约定

- 百分数统一用 `0-100` 输入，例如 `60` 代表 `60%`（不是 `0.6`）
- `-K` 模式收益率也使用百分数，例如 `20` 代表 `+20%`，`-10` 代表 `-10%`
- `-K` 中每个情景都必须给出全部标的的收益率，且收益率下限为 `-100%`
- `--json` 仅支持命令行参数模式，不支持交互输入

## 用法速查

```bash
bo                           # 默认交互（标准模式）
bo --json ...                # JSON 输出（仅命令行参数模式）

bo <赔率> <胜率> [本金]                                # 标准模式
bo -p <市场价格> <你的概率> [本金]                      # Polymarket
bo -s <当前价> <止盈价> <止损价> <胜率> [本金]           # 股票
bo -a <赔率1> <赔率2> [本金]                            # 双边套利
bo -A <标的数量> <赔率1> ... <赔率N> [本金]              # 多边套利
bo -n <a11> <a12> <a21> <a22> <b11> <b12> <b21> <b22> # 2x2纳什均衡

# 组合凯利（独立）
bo -k <标的数量> <赔率1> <胜率1> ... <赔率N> <胜率N> [本金]
bo -k <descriptor1> <descriptor2> ... [本金]

# 相关情景组合凯利（非独立）
bo -K <标的数量> <情景数量> <p1> <r11> ... <r1N> ... <pM> <rM1> ... <rMN> [本金]
```

## 模式详解

### 1) 标准模式

```bash
bo <赔率> <胜率> [本金]
bo --json <赔率> <胜率> [本金]
```

示例：

```bash
bo 2.0 60
bo 2.0 60 10000
```

### 2) Polymarket 模式

```bash
bo -p <市场价格> <你的概率> [本金]
bo --json -p <市场价格> <你的概率> [本金]
```

示例：

```bash
bo -p 60 75
bo -p 60 75 1000
```

### 3) 股票模式

```bash
bo -s <当前价> <止盈价> <止损价> <胜率> [本金]
bo --json -s <当前价> <止盈价> <止损价> <胜率> [本金]
```

示例：

```bash
bo -s 100 120 90 60
bo -s 100 120 90 60 10000
```

### 4) 双边套利/抽水模式

```bash
bo -a <赔率1> <赔率2> [本金]
bo --json -a <赔率1> <赔率2> [本金]
```

- `隐含概率和 < 100%`：存在套利
- `隐含概率和 = 100%`：无套利，抽水 0
- `隐含概率和 > 100%`：显示抽水率

示例：

```bash
bo -a 2.1 2.2
bo -a 1.9 1.9
bo -a 2.1 2.2 1000
```

### 5) 多边套利/抽水模式

```bash
bo -A <标的数量> <赔率1> <赔率2> ... <赔率N> [本金]
bo --json -A <标的数量> <赔率1> <赔率2> ... <赔率N> [本金]
```

示例：

```bash
bo -A 3 2.5 4.0 5.0
bo -A 3 2.0 3.5 4.0
bo -A 3 2.5 4.0 5.0 1000
```

### 6) 纳什均衡模式（2x2）

```bash
bo -n <a11> <a12> <a21> <a22> <b11> <b12> <b21> <b22>
bo --json -n <a11> <a12> <a21> <a22> <b11> <b12> <b21> <b22>
```

其中：

- `A = [[a11, a12], [a21, a22]]`：行玩家收益
- `B = [[b11, b12], [b21, b22]]`：列玩家收益

示例：

```bash
bo -n 3 0 5 1 3 5 0 1
bo --json -n 1 -1 -1 1 -1 1 1 -1
```

### 7) 组合凯利（独立，`-k`）

```bash
bo -k <标的数量> <赔率1> <胜率1> ... <赔率N> <胜率N> [本金]
bo --json -k <标的数量> <赔率1> <胜率1> ... <赔率N> <胜率N> [本金]
bo -k <descriptor1> <descriptor2> ... [本金]
bo --json -k <descriptor1> <descriptor2> ... [本金]
```

`descriptor` 支持：

- `std:赔率:胜率`（别名：`standard`）
- `pm:市场价格:你的概率`（别名：`polymarket`）
- `stock:当前价:止盈价:止损价:胜率`（别名：`stk`）
- `arb:赔率1:赔率2`
- `marb:赔率1,赔率2,...`

示例：

```bash
bo -k 2 2.0 60 2.5 55
bo -k 2 2.0 60 2.5 55 10000
bo -k std:2.0:60 pm:60:75 stock:100:120:90:60 10000
bo --json -k std:2.0:60 arb:2.1:2.2 marb:2.5,4.0,5.0 10000
```

### 8) 相关情景组合凯利（非独立，`-K`）

```bash
bo -K <标的数量> <情景数量> <p1> <r11> ... <r1N> ... <pM> <rM1> ... <rMN> [本金]
bo --json -K <标的数量> <情景数量> <p1> <r11> ... <r1N> ... <pM> <rM1> ... <rMN> [本金]
```

含义：

- `N`：标的数量
- `M`：情景数量
- `pi`：第 `i` 个情景概率（百分数）
- `rij`：第 `i` 个情景下第 `j` 个标的收益率（百分数）

示例：

```bash
bo -K 2 2 50 20 -10 50 -10 20
bo -K 2 2 50 20 -10 50 -10 20 10000
bo --json -K 2 3 30 25 -15 40 5 5 30 -10 20
```

如何处理非独立事件（建模流程）：

1. 列出“互斥且完备”的联合情景（例如同时考虑两场比赛/两只股票的联动结果）。
2. 给每个联合情景分配概率，所有情景概率总和约等于 `100`。
3. 在每个情景中，为每个标的填写对应收益率（百分数，最低 `-100`）。
4. 按 `bo -K <N> <M> <p1> <r11>...<r1N> ... <pM> <rM1>...<rMN> [本金]` 拼接参数。

示例（2 个标的，4 个相关情景）：

```bash
# 情景1 30%: [+20%, +15%]
# 情景2 20%: [+20%, -100%]
# 情景3 10%: [-100%, +15%]
# 情景4 40%: [-100%, -100%]
bo -K 2 4 30 20 15 20 20 -100 10 -100 15 40 -100 -100 10000
```

## 交互模式

仅带模式标志可进入对应交互：

```bash
bo
bo -p
bo -s
bo -a
bo -A
bo -n
bo -k
bo -K
```

## 数学说明

### 凯利公式（标准二项）

```text
f* = (bp - q) / b
```

- `b`：净赔率（赔率 - 1）
- `p`：胜率
- `q = 1 - p`

### 组合凯利（独立）

对每腿按独立二项枚举联合状态，最大化：

```text
max_f E[ ln( 1 + Σ f_i R_i ) ]
```

### 相关情景组合凯利（非独立）

直接输入联合情景 `{(π_s, r_s)}`，优化目标：

```text
max_f Σ_s π_s * ln( 1 + f · r_s )
s.t. f_i >= 0, Σ f_i <= 1
```

这避免了“独立事件假设”带来的仓位偏差。

## JSON 输出字段速览

- 顶层统一包含：`ok`、`mode`、`inputs`、`result`
- 带本金时额外包含 `sizing`（全凯利/半凯利/四分之一凯利金额）
- `-n` 关键字段：`pure_equilibria`、`mixed_equilibrium`
- `-k` / `-K` 关键字段：`allocations`、`total_allocation`、`expected_log_growth`
- `-k` / `-K` 关键字段：`expected_arithmetic_return`、`worst_case_multiplier`

## 开发与验证

```bash
cargo build --release
cargo run -- -h
cargo test
```
